<!DOCTYPE html>
<meta charset="utf-8">
<style>
body {
    text-align: center;
    font-family: SansSerif
}
    text {
        font: 10px sans-serif;
        text-anchor: middle;
    }

    .node circle {
        fill: #ddd;
    }

    .node circle.deputat {
        fill: #ff3f6a;
    }

    .node:hover circle {        
        stroke-width: 1.2px;
        fill: coral;
    }
    .viz {
        display: inline-block;
        margin: 0px;

        text-align: center;
        width: 45%;
        vertical-align: top; /* to keep from different alignment when one block is loaded but the other is not */
    }

</style>
<h1>Eлектронні декларації. Кеш.</h1>
<p>
    Просумовано капітал декларанта та його родини усіх видів та валют. Для наочності в кожній групі преведені лише перші сто найбагатших чиновників.
    <br/>
    Ім'я та посаду декларанта можна побачити при наведенні курсора. 1K = 1000.
</p>
<div class="viz">
<h3>Судді</h3>
<p id="sudy-loading-indicator">Завантаження...</p>
<svg id="sudy" width="500" height="500"><g transform="translate(1,1)"></g></svg>
</div>
<div class="viz">
<h3>Прокурорські</h3>
<p id="prokurory-loading-indicator">Завантаження...</p>
<svg id="prokurory" width="500" height="500"><g transform="translate(1,1)"></g></svg>
</div>
<div class="viz">
<h3>Слідчі</h3>
<p id="sledovateli-loading-indicator">Завантаження...</p>
<svg id="sledovateli" width="500" height="500"><g transform="translate(1,1)"></g></svg>
</div>
<div class="viz" style="width:100%">
<h3>Всі разом</h3>
<p>Перші 300. Червоним - Верховна Рада України</p>
<p id="vse-loading-indicator">Завантаження...</p>
<svg id="vse" width="900" height="900"><g transform="translate(1,1)"></g></svg>
    </div>
<script src="d3.js"></script>
<script>
    draw("sudy", "suddi.csv");
    draw("prokurory", "prokurory1.csv");
    draw("sledovateli", "sledovateli.csv");
    draw("vse", "cash.csv", 300);

function draw(id, fileName, limit, matches) {
    var svg = d3.select("#"+id),
            width = +svg.attr("width"),
            height = +svg.attr("height");
    var comaFormat = d3.format(",d");

    var pack = d3.pack()
            .size([width - 2, height - 2])
            .padding(3);
    var totalSum = 0;
    d3.csv(fileName, function (error, data) {
        if (error) throw error;

        var loadingIndicatorElement = document.getElementById(id + '-loading-indicator');
        //not using short element.remove() to support older browsers
        loadingIndicatorElement.parentNode.removeChild(loadingIndicatorElement);

        var modyfiedData = data.map(function (i) {
            var person = {
                name: i.name,
                id: i.uuid,
                office: i.office,
                position: i.position,
                uah: summCur(i, "UAH"),
                usd: summCur(i, "USD"),
                gbp: summCur(i, "GBP"),
                eur: summCur(i, "EUR")
            };
            person.total = person.uah / 26 + person.usd + person.gbp * 1.2 + person.eur * 1.09;
            return person;
        });

        var root = d3.hierarchy({
                    children: modyfiedData.filter(function (i) {
                        return i.total
                    })
                })
                .sum(function (d) {
                    return d.total;
                })
                .sort(function (a, b) {
                    return b.value - a.value;
                });
        root.children = root.children.filter(function (i, n) {
            return (n < (limit || 100)) && (matches ? (!!~i.data.position.toLowerCase().search(matches[0]) || !!~i.data.position.toLowerCase().search(matches[1])) : true); //matches.map(function(m) {return i.data.position.toLocaleLowerCase().match(m)});
        });
        pack(root);

        var node = svg.select("g")
                .selectAll("g")
                .data(root.children)
                .enter().append("g")
                .attr("transform", function (d) {
                    return "translate(" + d.x + "," + d.y + ")";
                })
                .attr("class", "node");

        node.append("circle")
                .attr("id", function (d) {
                    return "node-" + d.data.id;
                })
                .attr("class", function(d) {return ~["апарат верховної ради україни", "верховна рада україни", "верховна рада"].indexOf(d.data.office.toLowerCase()) ? "deputat"
                        :~["генеральна прокуратура", "генеральна прокуратура україни"].indexOf(d.data.office.toLowerCase()) ? "prokuratura"
                        : d.data.office.toLowerCase().match("міністерство") || d.data.office.toLowerCase().match("міністрів") ? "ministerstvo" : ""})
                .attr("r", function (d) {
                    return d.r;
                });

        node.append("clipPath")
                .attr("id", function (d) {
                    return "clip-" + d.data.id;
                })
                .append("use")
                .attr("xlink:href", function (d) {
                    return "#node-" + d.data.id + "";
                });
        node.append("text").text(function (d) {
            return "$" + comaFormat(Math.round(d.value / 1000)) + "K"
        });

        node.append("title")
                .text(function (d) {
                    return d.data.name + "\n" + d.data.position + "\n" + d.data.office + format(d.data.uah, "UAH") + format(d.data.usd, "USD") + format(d.data.eur, "EUR") + format(d.data.GBP, "GBP");
                });
    });

    function summCur(i, cur) {
        var map = ["готівкові кошти", "кошти, розміщені на банківських рахунках", "інше", "кошти, позичені третім особам", "активи у дорогоцінних (банківських) металах", "внески до кредитних спілок та інших небанківських фінансових установ"]
        var sum = 0;
        map.forEach(function (name) {
            var decl = i["Декларант/" + name + "/" + cur];
            var rod = i["Родина/" + name + "/" + cur];
            sum = sum + (!isNaN(+decl) ? +decl : 0) + (!isNaN(+rod) ? +rod : 0)
            if (isNaN(sum)) {
                debugger
            }
        });
        totalSum = totalSum + sum;
        if (isNaN(totalSum)) {
            debugger
        }
        return sum;
    }
    function format(d, label) {
        return d ? "\n" + label + ": " + comaFormat(Math.round(d / 1000)) + "K" : ""
    }
}
</script>
