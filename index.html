<!DOCTYPE html>
<meta charset="utf-8">
<style>
    @import url("https://fonts.googleapis.com/css?family=Pt+Sans");
    body {
        text-align: center;
        /*font-family: 'Open Sans', sans-serif;*/
        /*font-size: 1.6rem;*/
        /*color: #5f6d80;*/
        font-family: 'PT Sans', serif;
        font-weight: 300;
        color: #000000;
        font-size: 20px;
        line-height: 1.55;

    }
    .description {
        text-align: left;
        max-width: 760px;
        margin: 0 auto;
    }
    text {
        font-size: 10px;
        text-anchor: middle;
        cursor: pointer;
    }

    .node circle {
        fill: #ddd;
        cursor: pointer;
    }

    .node circle.deputat {
        fill: #ff3f6a;
    }

    .node circle.prokuratura{
        fill: #3b38ff;
    }
    /*.node circle.ministerstvo {*/
        /*fill: #ba54ff;*/
    /*}*/


    .node:hover circle {        
        stroke-width: 1.2px;
        fill: #ff719a;
    }
    .viz {
        display: inline-block;
        margin: 0px;
        min-width: 480px;
        text-align: center;
        width: 45%;
        vertical-align: top; /* to keep from different alignment when one block is loaded but the other is not */
    }
    .loading {
        animation: blinker 1s linear infinite;
        font-size: 1.5em;
        margin: 50px;
    }

    @keyframes blinker {
        50% { opacity: 0; }
    }

    @media screen and (max-width: 1200px) {
        body {
            font-size: 18px;
        }
        .description {
            max-width: 620px;
        }
    }

</style>
<h1>Eлектронні декларації. Кеш.</h1>
<p class="description">
    Просумовано капітал декларанта та його родини усіх видів та валют. Для наочності в кожній групі преведені лише перші сто найбагатших чиновників.
    Ім'я та посаду декларанта можна побачити при наведенні курсора. 1K = 1000.
</p>
<div class="viz">
<h3>Судді</h3>
<p class="loading" id="sudy-loading-indicator">Завантаження...</p>
<svg id="sudy" width="500" height="500"><g transform="translate(1,1)"></g></svg>
</div>
<div class="viz">
<h3>Прокурори</h3>
<p class="loading" id="prokurory-loading-indicator">Завантаження...</p>
<svg id="prokurory" width="500" height="500"><g transform="translate(1,1)"></g></svg>
</div>
<div class="viz">
<h3>Слідчі</h3>
<p class="loading" id="sledovateli-loading-indicator">Завантаження...</p>
<svg id="sledovateli" width="500" height="500"><g transform="translate(1,1)"></g></svg>
</div>
<div class="viz" style="width:100%">
<h3>Всі разом</h3>
<p>Перші 300. Червоним - Верховна Рада України</p>
<p class="loading" id="vse-loading-indicator">Завантаження...</p>
<svg id="vse" width="900" height="900"><g transform="translate(1,1)"></g></svg>
    </div>
<script src="d3.js"></script>
<script>
    draw("sudy", "suddi.csv");
    draw("prokurory", "prokurory1.csv");
    draw("sledovateli", "sledovateli.csv");
    draw("vse", "cash.csv", 300);

function draw(id, fileName, limit, matches) {
    var svg = d3.select("#"+id),
            width = +svg.attr("width"),
            height = +svg.attr("height");
    var comaFormat = d3.format(",d");

    var pack = d3.pack()
            .size([width - 2, height - 2])
            .padding(3);
    var totalSum = 0;
    d3.csv(fileName, function (error, data) {
        if (error) throw error;

        var loadingIndicatorElement = document.getElementById(id + '-loading-indicator');
        //not using short element.remove() to support older browsers
        loadingIndicatorElement.parentNode.removeChild(loadingIndicatorElement);

        var modyfiedData = data.map(function (i) {
            var person = {
                name: i.name,
                id: i.uuid,
                office: i.office,
                position: i.position,
                uah: summCur(i, "UAH"),
                usd: summCur(i, "USD"),
                gbp: summCur(i, "GBP"),
                eur: summCur(i, "EUR")
            };
            person.total = person.uah / 26 + person.usd + person.gbp * 1.2 + person.eur * 1.09;
            return person;
        });

        var root = d3.hierarchy({
                    children: modyfiedData.filter(function (i) {
                        return i.total
                    })
                })
                .sum(function (d) {
                    return d.total;
                })
                .sort(function (a, b) {
                    return b.value - a.value;
                });
        root.children = root.children.filter(function (i, n) {
            return (n < (limit || 100)) && (matches ? (!!~i.data.position.toLowerCase().search(matches[0]) || !!~i.data.position.toLowerCase().search(matches[1])) : true); //matches.map(function(m) {return i.data.position.toLocaleLowerCase().match(m)});
        });
        pack(root);

        var node = svg.select("g")
                .selectAll("g")
                .data(root.children)
                .enter().append("g")
                .attr("transform", function (d) {
                    return "translate(" + d.x + "," + d.y + ")";
                })
                .attr("class", "node");

        node.append("circle")
                .attr("id", function (d) {
                    return "node-" + d.data.id;
                })
                .attr("class", defineClassByOffice)
                .attr("r", function (d) { return d.r});

        node.append("clipPath")
                .attr("id", function (d) {
                    return "clip-" + d.data.id;
                })
                .append("use")
                .attr("xlink:href", function (d) {
                    return "#node-" + d.data.id + "";
                });
        node.append("text").text(function (d) {
            return "$" + comaFormat(Math.round(d.value / 1000)) + "K"
        });

        node.append("title")
                .text(function (d) {
                    return d.data.name + "\n" + d.data.position + "\n" + d.data.office + format(d.data.uah, "UAH") + format(d.data.usd, "USD") + format(d.data.eur, "EUR") + format(d.data.GBP, "GBP");
                });
    });

    function summCur(i, cur) {
        var map = ["готівкові кошти", "кошти, розміщені на банківських рахунках", "інше", "кошти, позичені третім особам", "активи у дорогоцінних (банківських) металах", "внески до кредитних спілок та інших небанківських фінансових установ"]
        var sum = 0;
        map.forEach(function (name) {
            var decl = i["Декларант/" + name + "/" + cur];
            var rod = i["Родина/" + name + "/" + cur];
            sum = sum + (!isNaN(+decl) ? +decl : 0) + (!isNaN(+rod) ? +rod : 0);
        });
        return sum;
    }
    function format(d, label) {
        return d ? "\n" + label + ": " + comaFormat(Math.round(d / 1000)) + "K" : ""
    }

    function defineClassByOffice(d) {
        var prokuraturaMap = ["генеральна прокуратура", "генеральна прокуратура україни", "прокуратура"];
        var deputatyMap = ["апарат верховної ради україни", "верховна рада україни", "верховна рада"];
        var ofice = d.data.office.toLowerCase();
        var position = d.data.position.toLowerCase();
        return ~deputatyMap.indexOf(ofice) ? "deputat"
            :~prokuraturaMap.indexOf(ofice) || ~ofice.search("прокур") || ~position.search("прокур") ? "prokuratura"
            : ~ofice.search("мініст") || ~position.search("мініст") ? "ministerstvo" : "";
    }
}
</script>
